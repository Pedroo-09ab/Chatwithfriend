<!doctype html>
<html lang="fr" class="h-full">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Bubble Chat</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700&amp;display=swap" rel="stylesheet">
  <style>
    body {
      box-sizing: border-box;
      font-family: 'Nunito', sans-serif;
    }
    
    .bubble-input {
      border-radius: 25px;
    }
    
    .bubble-btn {
      border-radius: 25px;
    }
    
    .message-bubble {
      border-radius: 20px;
      min-width: 200px;
      max-width: 85%;
      word-wrap: break-word;
    }
    
    .message-bubble.sent {
      border-bottom-right-radius: 6px;
    }
    
    .message-bubble.received {
      border-bottom-left-radius: 6px;
    }
    
    .emoji-panel {
      border-radius: 20px;
    }
    
    .card {
      border-radius: 30px;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .animate-fade-in {
      animation: fadeIn 0.3s ease-out forwards;
    }
    
    @keyframes bounce-in {
      0% { transform: scale(0.8); opacity: 0; }
      50% { transform: scale(1.05); }
      100% { transform: scale(1); opacity: 1; }
    }
    
    .animate-bounce-in {
      animation: bounce-in 0.4s ease-out forwards;
    }
    
    .messages-container::-webkit-scrollbar {
      width: 6px;
    }
    
    .messages-container::-webkit-scrollbar-track {
      background: transparent;
    }
    
    .messages-container::-webkit-scrollbar-thumb {
      background: #d1d5db;
      border-radius: 3px;
    }
  </style>
  <style>@view-transition { navigation: auto; }</style>
 </head>
 <body class="h-full m-0 overflow-hidden">
  <div id="app" class="h-full w-full relative overflow-hidden" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);"><!-- √âcran de connexion -->
   <div id="login-screen" class="absolute inset-0 flex items-center justify-center px-4">
    <div class="card p-8 shadow-2xl animate-bounce-in" style="background-color: #ffffff;"><!-- Logo / Titre -->
     <div class="text-center mb-8">
      <div class="w-20 h-20 mx-auto mb-4 rounded-full flex items-center justify-center shadow-lg" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
       <svg class="w-10 h-10 text-white" fill="currentColor" viewbox="0 0 24 24"><path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm0 14H6l-2 2V4h16v12z" /> <circle cx="8" cy="10" r="1.5" /> <circle cx="12" cy="10" r="1.5" /> <circle cx="16" cy="10" r="1.5" />
       </svg>
      </div>
      <h1 id="app-title" class="text-2xl font-bold" style="color: #333333;">Bubble Chat</h1>
      <p id="welcome-text" class="mt-2" style="color: #666666;">Bienvenue !</p>
     </div><!-- √âtape 1: Code -->
     <div id="code-step">
      <div class="mb-4"><input type="password" id="code-input" class="bubble-input w-full px-5 py-3 border-2 focus:outline-none focus:border-purple-500 transition-colors" style="background-color: #f8f9fa; border-color: #e9ecef; color: #333333;" placeholder="Entrez le code secret...">
       <p id="code-error" class="text-red-500 text-sm mt-2 hidden px-2">‚ùå Code incorrect ou vide</p>
      </div><button id="validate-code-btn" class="bubble-btn w-full py-3 font-semibold text-white shadow-lg hover:shadow-xl transform hover:scale-105 transition-all" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);"> Valider ‚ú® </button>
     </div><!-- √âtape 2: Pseudo -->
     <div id="pseudo-step" class="hidden">
      <div class="mb-4"><input type="text" id="pseudo-input" class="bubble-input w-full px-5 py-3 border-2 focus:outline-none focus:border-purple-500 transition-colors" style="background-color: #f8f9fa; border-color: #e9ecef; color: #333333;" placeholder="Votre pseudo..." maxlength="20">
       <p id="pseudo-error" class="text-red-500 text-sm mt-2 hidden px-2">‚ùå Veuillez entrer un pseudo</p>
      </div><button id="continue-btn" class="bubble-btn w-full py-3 font-semibold text-white shadow-lg hover:shadow-xl transform hover:scale-105 transition-all" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);"> Continuer üöÄ </button>
     </div>
    </div>
   </div>
   <div id="blocked-screen" class="hidden absolute inset-0 flex items-center justify-center px-6">
  <div class="card p-8 shadow-2xl text-center" style="background-color:#ffffff; max-width:520px; width:100%;">
    <h2 class="text-2xl font-bold" style="color:#ff6b6b;">üö´ Vous √™tes exclu</h2>
    <p class="mt-3" style="color:#666666;">
      Un administrateur vous a retir√© l‚Äôacc√®s √† ce chat.
    </p>
    <p class="mt-2 text-sm" style="color:#888888;">
      Si c‚Äôest une erreur, demandez √† √™tre r√©activ√©.
    </p>
  </div>
</div>
<!-- √âcran Chat -->
   <div id="chat-screen" class="hidden absolute inset-0 w-full h-full flex flex-col"><!-- Header -->
    <div class="px-4 py-3 shadow-md flex items-center justify-between" style="background-color: #ffffff;">
     <div class="flex items-center gap-3">
      <div class="w-10 h-10 rounded-full flex items-center justify-center" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
       <svg class="w-5 h-5 text-white" fill="currentColor" viewbox="0 0 24 24"><path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2z" />
       </svg>
      </div>
      <div>
       <h2 id="chat-title" class="font-bold">Bubble Chat</h2>
       <p id="chat-status" class="text-xs">En ligne ‚Ä¢ <span id="user-display"></span></p>
      </div>
     </div>
     <div class="flex items-center gap-2"><button id="manage-users-btn" class="hidden p-2 rounded-full hover:bg-gray-100 transition-colors" title="G√©rer les utilisateurs">
       <svg class="w-5 h-5" style="color: #ff6b6b;" fill="currentColor" viewbox="0 0 24 24"><path d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5c-1.66 0-3 1.34-3 3s1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5C6.34 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5c0-2.33-4.67-3.5-7-3.5zm8 0c-.29 0-.62.02-.97.05 1.16.84 1.97 1.97 1.97 3.45V19h6v-2.5c0-2.33-4.67-3.5-7-3.5z" />
       </svg></button> <button id="theme-btn" class="p-2 rounded-full hover:bg-gray-100 transition-colors" title="Changer le th√®me">
       <svg id="theme-icon-light" class="w-5 h-5" style="color: #666666;" fill="currentColor" viewbox="0 0 24 24"><path d="M12 7c-2.76 0-5 2.24-5 5s2.24 5 5 5 5-2.24 5-5-2.24-5-5-5zM2 13h2c.55 0 1-.45 1-1s-.45-1-1-1H2c-.55 0-1 .45-1 1s.45 1 1 1zm18 0h2c.55 0 1-.45 1-1s-.45-1-1-1h-2c-.55 0-1 .45-1 1s.45 1 1 1zM11 2v2c0 .55.45 1 1 1s1-.45 1-1V2c0-.55-.45-1-1-1s-1 .45-1 1zm0 18v2c0 .55.45 1 1 1s1-.45 1-1v-2c0-.55-.45-1-1-1s-1 .45-1 1zM5.99 4.58c-.39-.39-1.03-.39-1.41 0-.39.39-.39 1.03 0 1.41l1.06 1.06c.39.39 1.03.39 1.41 0s.39-1.03 0-1.41L5.99 4.58zm12.37 12.37c-.39-.39-1.03-.39-1.41 0-.39.39-.39 1.03 0 1.41l1.06 1.06c.39.39 1.03.39 1.41 0 .39-.39.39-1.03 0-1.41l-1.06-1.06zm1.06-10.96c.39-.39.39-1.03 0-1.41-.39-.39-1.03-.39-1.41 0l-1.06 1.06c-.39.39-.39 1.03 0 1.41s1.03.39 1.41 0l1.06-1.06zM7.05 18.36c.39-.39.39-1.03 0-1.41-.39-.39-1.03-.39-1.41 0l-1.06 1.06c-.39.39-.39 1.03 0 1.41s1.03.39 1.41 0l1.06-1.06z" />
       </svg>
       <svg id="theme-icon-dark" class="w-5 h-5 hidden" style="color: #666666;" fill="currentColor" viewbox="0 0 24 24"><path d="M10 2c-1.82 0-3.53.5-5 1.35C7.99 5.08 10 8.3 10 12s-2.01 6.92-5 8.65C6.47 21.5 8.18 22 10 22c5.52 0 10-4.48 10-10S15.52 2 10 2z" />
       </svg></button> <button id="logout-btn" class="p-2 rounded-full hover:bg-gray-100 transition-colors" title="D√©connexion">
       <svg class="w-5 h-5" style="color: #666666;" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
       </svg></button>
     </div>
    </div><!-- Messages -->
    <!-- Online bar -->
<div id="online-bar" class="flex items-center gap-2 px-4 py-2 overflow-x-auto border-b"
     style="background-color:#ffffff; border-color: rgba(0,0,0,0.08);">
  <span class="text-xs opacity-70 whitespace-nowrap">En ligne :</span>
  <div id="online-users" class="flex items-center gap-2"></div>
</div>

    <div id="messages-container" class="messages-container flex-1 overflow-y-auto px-2 py-4 space-y-3" style="background-color: #f0f2f5;"><!-- Messages will be inserted here -->
    </div><!-- Emoji Panel -->
    <div id="emoji-panel" class="hidden emoji-panel mx-4 mb-2 p-3 shadow-lg grid grid-cols-8 gap-2 max-h-40 overflow-y-auto" style="background-color: #ffffff;"><!-- Emojis will be inserted here -->
    </div><!-- Users Management Panel (Admin only) -->
    <div id="users-panel" class="hidden mx-4 mb-2 p-4 shadow-lg rounded-2xl" style="background-color: #ffffff;">
     <div class="flex items-center justify-between mb-3">
      <h3 class="font-bold text-lg" style="color: #ff6b6b;">üë• Gestion des utilisateurs</h3><button id="close-users-panel" class="p-1 rounded-full hover:bg-gray-100 transition-colors">
       <svg class="w-5 h-5" style="color: #666666;" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
       </svg></button>
     </div>
     <div id="users-list" class="space-y-2 max-h-60 overflow-y-auto"><!-- Users will be inserted here -->
     </div>
    </div><!-- Input Area -->
    <div class="p-4" style="background-color: #ffffff;">
     <div class="flex items-center gap-2"><button id="emoji-btn" class="p-3 rounded-full hover:bg-gray-100 transition-colors flex-shrink-0" title="Emojis">
       <svg class="w-6 h-6" style="color: #667eea;" fill="currentColor" viewbox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm3.5-9c.83 0 1.5-.67 1.5-1.5S16.33 8 15.5 8 14 8.67 14 9.5s.67 1.5 1.5 1.5zm-7 0c.83 0 1.5-.67 1.5-1.5S9.33 8 8.5 8 7 8.67 7 9.5 7.67 11 8.5 11zm3.5 6.5c2.33 0 4.31-1.46 5.11-3.5H6.89c.8 2.04 2.78 3.5 5.11 3.5z" />
       </svg></button> <input type="text" id="message-input" class="bubble-input flex-1 px-5 py-3 border-2 focus:outline-none focus:border-purple-500 transition-colors" style="background-color: #f8f9fa; border-color: #e9ecef; color: #333333;" placeholder="√âcrivez un message..." maxlength="500"> <button id="send-btn" class="p-3 rounded-full text-white shadow-md hover:shadow-lg transform hover:scale-105 transition-all flex-shrink-0" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);" title="Envoyer">
       <svg class="w-6 h-6" fill="currentColor" viewbox="0 0 24 24"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z" />
       </svg></button>
     </div>
    </div>
   </div>
  </div>
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
  import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-auth.js";
  import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, doc, setDoc, deleteDoc, serverTimestamp, getDocs, writeBatch, limit } 
from "https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore.js";
  
  const firebaseConfig = {
    apiKey: "AIzaSyCqX2QurFYbvK4jrAsNXGh7_bUiCMhxr1Y",
    authDomain: "chronocour-chat.firebaseapp.com",
    projectId: "chronocour-chat",
    storageBucket: "chronocour-chat.firebasestorage.app",
    messagingSenderId: "407414363543",
    appId: "1:407414363543:web:eb0fd96d7191b4660660d2",
    measurementId: "G-KG0HX1XLQ4"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  // Objet global pour ton gros script (non-module)
  window.BUBBLE_AUTH = { uid: null, db, collection, addDoc, query, orderBy, onSnapshot, doc, setDoc, deleteDoc, serverTimestamp, getDocs, writeBatch, limit
 };

  // Auth anonyme
  signInAnonymously(auth).catch(console.error);

  onAuthStateChanged(auth, (user) => {
    if (user) {
      window.BUBBLE_AUTH.uid = user.uid;

// üü¢ Presence simple (heartbeat)
const meRef = doc(db, "rooms", "general", "presence", user.uid);

async function pingPresence() {
  await setDoc(meRef, {
    uid: user.uid,
    pseudo: localStorage.getItem("bubbleChat_user") || "Sans pseudo",
    lastSeen: serverTimestamp()
  }, { merge: true });
}

pingPresence();
setInterval(pingPresence, 20000);

      console.log("‚úÖ UID Firebase :", user.uid);
    }
  });

  // (Optionnel) √©coute temps r√©el - on la rebranche juste apr√®s que db soit OK
  const ref = collection(db, "rooms", "general", "messages");
  const q = query(ref, orderBy("timestamp", "asc"));

  onSnapshot(q, (snap) => {
  const list = [];
  snap.forEach((d) => {
    // ‚úÖ on garde l'ID du document Firestore
    list.push({ _docId: d.id, ...d.data() });
  });

  window.dispatchEvent(
    new CustomEvent("bubble-firestore-messages", { detail: list })
  );
});

// üö´ Ecoute temps r√©el des exclusions
const blockedRef = collection(db, "rooms", "general", "blocked");

onSnapshot(blockedRef, (snap) => {
  const list = [];
  snap.forEach((d) => list.push(d.id)); // d.id = uid exclu
  window.dispatchEvent(new CustomEvent("bubble-firestore-blocked", { detail: list }));
});

// üü¢ Ecoute temps r√©el de la pr√©sence
const presenceRef = collection(db, "rooms", "general", "presence");

onSnapshot(presenceRef, (snap) => {
  const list = [];
  snap.forEach((d) => list.push(d.data()));
  window.dispatchEvent(new CustomEvent("bubble-firestore-presence", { detail: list }));
});

</script>

  <script>
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê     ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê   ‚ïê‚ïê‚ïê‚ïê‚ïê     ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // CONFIGURATION - Modifiez les codes secrets ici
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê   ‚ïê‚ïê
    const CODE_SECRET = "48317";
    const CODE_ADMIN = "ADMIN253";
    
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê   ‚ïê‚ïê‚ïê‚ïê
    // EMOJIS DISPONIBLES
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê     ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê   ‚ïê‚ïê
    const EMOJIS = [
  "üòÄ","üòÉ","üòÑ","üòÅ","üòÖ","üòÇ","ü§£","üòä",
  "üòá","üôÇ","üôÉ","üòç","üòò","üòó","üòã","üòõ",
  "üòú","üòé","ü´†","ü•≥","üò≠","üò¢","üòû","üòî",
  "üò©","üò§","ü§Ø","üò±","ü•∂","ü§ó","ü§î","ü§´",
  "üëç","üëé","üëè","üôå","ü§ù","üôè","üí™","‚ù§Ô∏è",
  "üß°","üíõ","üíö","üíô","üíú","üñ§","üíî","‚ú®",
  "üî•","‚≠ê","üåü","üí´","üéâ","üéä","üéÅ","üéà"
];

    
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // DEFAULT CONFIG & SDK SETUP
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    const defaultConfig = {
      app_title: "Bubble Chat",
      welcome_message: "Bienvenue !",
      code_placeholder: "Entrez le code secret...",
      pseudo_placeholder: "Votre pseudo...",
      primary_color: "#667eea",
      secondary_color: "#764ba2",
      background_color: "#ffffff",
      text_color: "#333333",
      surface_color: "#f8f9fa"
    };
    
    let config = { ...defaultConfig };
    
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê   ‚ïê‚ïê‚ïê  ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // STATE
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    let currentUser = localStorage.getItem('bubbleChat_user') || null;
    let isAdmin = localStorage.getItem('bubbleChat_isAdmin') === 'true';
    let messages = JSON.parse(localStorage.getItem('bubbleChat_messages') || '[]');
    let isEmojiPanelOpen = false;
    let isDarkMode = localStorage.getItem('bubbleChat_darkMode') === 'true';
    let blockedUsers = JSON.parse(localStorage.getItem('bubbleChat_blockedUsers') || '[]');
    let isUsersPanelOpen = false;
    
    let blockedUids = JSON.parse(localStorage.getItem('bubbleChat_blockedUids') || '[]');
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê      ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê     ‚ïê‚ïê‚ïê‚ïê     ‚ïê‚ïê  ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê     ‚ïê
    // DOM ELEMENTS
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê   ‚ïê‚ïê‚ïê   ‚ïê‚ïê‚ïê‚ïê‚ïê  ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    const loginScreen = document.getElementById('login-screen');
    const chatScreen = document.getElementById('chat-screen');
    const codeStep = document.getElementById('code-step');
    const pseudoStep = document.getElementById('pseudo-step');
    const codeInput = document.getElementById('code-input');
    const pseudoInput = document.getElementById('pseudo-input');
    const codeError = document.getElementById('code-error');
    const pseudoError = document.getElementById('pseudo-error');
    const validateCodeBtn = document.getElementById('validate-code-btn');
    const continueBtn = document.getElementById('continue-btn');
    const messagesContainer = document.getElementById('messages-container');
    const onlineUsersEl = document.getElementById('online-users');
    const messageInput = document.getElementById('message-input');
    const sendBtn = document.getElementById('send-btn');
    const emojiBtn = document.getElementById('emoji-btn');
    const emojiPanel = document.getElementById('emoji-panel');
    const userDisplay = document.getElementById('user-display');
    const logoutBtn = document.getElementById('logout-btn');
    const themeBtn = document.getElementById('theme-btn');
    const themeIconLight = document.getElementById('theme-icon-light');
    const themeIconDark = document.getElementById('theme-icon-dark');
    const chatHeader = document.querySelector('#chat-screen > div:first-child');
    const inputArea = document.querySelector('#chat-screen > div:last-child');
    const chatTitle = document.getElementById('chat-title');
    const chatStatus = document.getElementById('chat-status');
    const manageUsersBtn = document.getElementById('manage-users-btn');
    const usersPanel = document.getElementById('users-panel');
    const closeUsersPanel = document.getElementById('close-users-panel');
    const usersList = document.getElementById('users-list');
    const blockedScreen = document.getElementById('blocked-screen');

    
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê   ‚ïê‚ïê‚ïê‚ïê‚ïê   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê       ‚ïê‚ïê  ‚ïê      ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // FUNCTIONS
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê  ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    
    function checkBlockedState() {
  if (isAdmin) return; // l'admin ne se bloque pas lui-m√™me

  const myUid = window.BUBBLE_AUTH?.uid;
  const isBlocked = !!myUid && blockedUids.includes(myUid);

  blockedScreen.classList.toggle('hidden', !isBlocked);
  chatScreen.classList.toggle('hidden', isBlocked);

  if (isBlocked) {
    // coupe l'input visuellement aussi (optionnel)
    messageInput.value = '';
    messageInput.blur();
  }
}
    function initEmojiPanel() {
      emojiPanel.innerHTML = '';
      EMOJIS.forEach(emoji => {
        const btn = document.createElement('button');
        btn.className = 'text-2xl p-1 hover:bg-gray-100 rounded-lg transition-colors';
        btn.textContent = emoji;
        btn.addEventListener('click', () => {
          messageInput.value += emoji;
          messageInput.focus();
        });
        emojiPanel.appendChild(btn);
      });
    }
    
    function toggleEmojiPanel() {
      isEmojiPanelOpen = !isEmojiPanelOpen;
      emojiPanel.classList.toggle('hidden', !isEmojiPanelOpen);
    }
    
    function toggleUsersPanel() {
      if (!isAdmin) return;
      isUsersPanelOpen = !isUsersPanelOpen;
      usersPanel.classList.toggle('hidden', !isUsersPanelOpen);
      if (isUsersPanelOpen) {
        renderUsersList();
        // Close emoji panel if open
        if (isEmojiPanelOpen) {
          toggleEmojiPanel();
        }
      }
    }
    
    function renderUsersList() {
      // Extraire tous les utilisateurs uniques des messages
      const usersMap = new Map();
messages.forEach((msg) => {
  if (!msg.uid) return;
  if (msg.user === '[ADMIN]') return;
  // garde le dernier pseudo vu pour ce uid
  usersMap.set(msg.uid, msg.user || 'Sans pseudo');
});
const users = Array.from(usersMap.entries());
      usersList.innerHTML = '';
// üî• Bouton admin: vider le salon
const clearWrap = document.createElement('div');
clearWrap.className = 'flex items-center justify-between p-3 rounded-lg mb-3';
clearWrap.style.backgroundColor = 'rgba(255, 107, 107, 0.08)';

clearWrap.innerHTML = `
  <div>
    <p class="font-semibold" style="color:#ff6b6b;">Danger zone</p>
    <p class="text-xs opacity-70">Supprime tous les messages pour tout le monde.</p>
  </div>
  <button onclick="clearAllMessages()"
          class="px-3 py-2 rounded-lg text-xs text-white hover:opacity-90"
          style="background-color:#ff6b6b;">
    Vider le salon
  </button>
`;

if (isAdmin) usersList.appendChild(clearWrap);

      
      if (users.length === 0) {
        usersList.innerHTML = `
          <p class="text-center py-4" style="color: #888888;">Aucun utilisateur pour le moment</p>
        `;
        return;
      }
      
      users.forEach(([uid, pseudo]) => {
        const isBlocked = blockedUids.includes(uid);
        const userEl = document.createElement('div');
        userEl.className = 'flex items-center justify-between p-3 rounded-lg transition-colors';
        userEl.style.backgroundColor = isBlocked ? '#ffe5e5' : '#f8f9fa';
        
        userEl.innerHTML = `
          <div class="flex items-center gap-3">
            <div class="w-10 h-10 rounded-full flex items-center justify-center text-sm font-semibold" style="background-color: ${isBlocked ? '#ffb3b3' : '#e9ecef'}; color: #666666;">
              ${escapeHtml((pseudo || '?').charAt(0).toUpperCase())}
            </div>
            <div>
              <p class="font-semibold" style="color: ${isBlocked ? '#ff6b6b' : '#333333'};">${escapeHtml(pseudo)}</p>
              <p class="text-xs" style="color: #888888;">${isBlocked ? 'üö´ Exclu' : '‚úì Actif'}</p>
            </div>
          </div>
          <button 
            onclick="toggleBlockUid('${uid}')"
            class="px-4 py-2 rounded-full text-sm font-semibold transition-all hover:shadow-md"
            style="background-color: ${isBlocked ? '#4ade80' : '#ff6b6b'}; color: white;"
          >
            ${isBlocked ? 'R√©activer' : 'Exclure'}
          </button>
        `;
        
        usersList.appendChild(userEl);
      });
    }
    
    function toggleBlockUser(username) {
      if (!isAdmin) return;
      
      const index = blockedUsers.indexOf(username);
      if (index > -1) {
        // D√©bloquer l'utilisateur
        blockedUsers.splice(index, 1);
        addSystemMessage(`‚úÖ ${username} a √©t√© r√©activ√© par l'admin.`);
      } else {
        // Bloquer l'utilisateur
        blockedUsers.push(username);
        addSystemMessage(`üö´ ${username} a √©t√© exclu par l'admin.`);
      }
      
      localStorage.setItem('bubbleChat_blockedUsers', JSON.stringify(blockedUsers));
      renderUsersList();
      renderMessages();
    }
    
    // Rendre la fonction accessible globalement
    window.toggleBlockUser = toggleBlockUser;
    
    function showCodeError(show) {
      codeError.classList.toggle('hidden', !show);
      if (show) {
        codeInput.classList.add('border-red-400');
        codeInput.classList.remove('border-purple-500');
      } else {
        codeInput.classList.remove('border-red-400');
      }
    }
    
    async function toggleBlockUid(uid) {
  if (!isAdmin) return;

  const db = window.BUBBLE_AUTH?.db;
  if (!db) {
    console.log("‚õî Pas de db Firestore");
    return;
  }

  const ref = window.BUBBLE_AUTH.doc(db, "rooms", "general", "blocked", uid);

  const isBlocked = blockedUids.includes(uid);

  try {
    if (isBlocked) {
      // R√©activer
      await window.BUBBLE_AUTH.deleteDoc(ref);
      addSystemMessage("‚úÖ Un utilisateur a √©t√© r√©activ√© par l‚Äôadmin.");
    } else {
      // Exclure
      await window.BUBBLE_AUTH.setDoc(ref, {
        uid,
        by: window.BUBBLE_AUTH.uid,
        ts: new Date().toISOString()
      });
      addSystemMessage("üö´ Un utilisateur a √©t√© exclu par l‚Äôadmin.");
    }
  } catch (e) {
    console.error("‚ùå Erreur exclusion Firestore", e);
  }
}

// üîì IMPORTANT : rendre la fonction accessible aux boutons HTML
window.toggleBlockUid = toggleBlockUid;

    function showPseudoError(show) {
      pseudoError.classList.toggle('hidden', !show);
      if (show) {
        pseudoInput.classList.add('border-red-400');
        pseudoInput.classList.remove('border-purple-500');
      } else {
        pseudoInput.classList.remove('border-red-400');
      }
    }
    
    function validateCode() {
      const code = codeInput.value.trim();
      if (code === '') {
        showCodeError(true);
        return;
      }
      
      // V√©rifier si c'est le code admin
      if (code === CODE_ADMIN) {
        isAdmin = true;
        localStorage.setItem('bubbleChat_isAdmin', 'true');
        currentUser = '[ADMIN]';
        localStorage.setItem('bubbleChat_user', currentUser);
        showCodeError(false);
        localStorage.setItem('bubbleChat_authed', 'true');
        showChatScreen();
        return;
      }
      
      // V√©rifier si c'est le code utilisateur normal
      if (code === CODE_SECRET) {
        isAdmin = false;
        localStorage.setItem('bubbleChat_isAdmin', 'false');
        showCodeError(false);
        codeStep.classList.add('hidden');
        pseudoStep.classList.remove('hidden');
        pseudoInput.focus();
        return;
      }
      
      // Code invalide
      showCodeError(true);
    }
    
    function validatePseudo() {
      const pseudo = pseudoInput.value.trim();
      if (pseudo === '') {
        showPseudoError(true);
        return;
      }
      showPseudoError(false);
      currentUser = pseudo;
      isAdmin = false;
      localStorage.setItem('bubbleChat_user', currentUser);
      localStorage.setItem('bubbleChat_isAdmin', 'false');
      localStorage.setItem('bubbleChat_authed', 'true');
      showChatScreen();
    }
    
    function showChatScreen() {
      loginScreen.classList.add('hidden');
      chatScreen.classList.remove('hidden');
      userDisplay.textContent = currentUser;
      
      // Modifier l'affichage selon le mode
      if (isAdmin) {
        chatStatus.innerHTML = `<span style="color: #ff6b6b; font-weight: bold;">‚ö° MODE ADMIN</span>`;
        manageUsersBtn.classList.remove('hidden');
      } else {
        chatStatus.innerHTML = `En ligne ‚Ä¢ <span id="user-display">${currentUser}</span>`;
        manageUsersBtn.classList.add('hidden');
      }
      
      renderMessages();
      messageInput.focus();
      
      // Add welcome message if no messages
      if (messages.length === 0) {
        if (isAdmin) {
          addSystemMessage("‚ö° Vous √™tes connect√© en mode ADMIN. Vous pouvez g√©rer tous les messages.");
        } else {
          addSystemMessage("üí¨ Discussion pr√™te ! Partagez le code √† vos potes pour qu'ils vous rejoignent.");
        }
      }
    }
    
    function showLoginScreen() {
      chatScreen.classList.add('hidden');
      loginScreen.classList.remove('hidden');
      codeStep.classList.remove('hidden');
      pseudoStep.classList.add('hidden');
      codeInput.value = '';
      pseudoInput.value = '';
      showCodeError(false);
      showPseudoError(false);
    }
    
    function logout() {
      currentUser = null;
      isAdmin = false;
      localStorage.removeItem('bubbleChat_user');
      localStorage.removeItem('bubbleChat_isAdmin');
      showLoginScreen();
      localStorage.removeItem('bubbleChat_authed');
    }
    
    function addSystemMessage(text) {
      const msg = {
        id: Date.now(),
        type: 'system',
        text: text,
        timestamp: new Date().toISOString()
      };
      messages.push(msg);
      saveMessages();
      renderMessages();
    }
    
    function sendMessage() {
      const text = messageInput.value.trim();
      if (text === '') return;
      
      // V√©rifier si l'utilisateur est bloqu√©
      if (!isAdmin && blockedUsers.includes(currentUser)) {
        // Cr√©er un message d'erreur temporaire
        const errorMsg = document.createElement('div');
        errorMsg.className = 'fixed top-20 left-1/2 transform -translate-x-1/2 px-6 py-3 rounded-full shadow-lg z-50';
        errorMsg.style.backgroundColor = '#ff6b6b';
        errorMsg.style.color = 'white';
        errorMsg.innerHTML = 'üö´ Vous avez √©t√© exclu par l\'administrateur';
        document.body.appendChild(errorMsg);
        
        setTimeout(() => {
          errorMsg.remove();
        }, 3000);
        
        messageInput.value = '';
        return;
      }
      
      const msg = {
        id: Date.now(),
        type: 'sent',
        uid: window.BUBBLE_AUTH?.uid || null,
        user: currentUser,
        text: text,
        timestamp: new Date().toISOString()
      };
      
      messages.push(msg);
      saveMessages();
      renderMessages();
      messageInput.value = '';

      // ‚úÖ Envoi vers Firestore (salon unique)
(async () => {
  try {
    const uid = window.BUBBLE_AUTH?.uid;
    const db = window.BUBBLE_AUTH?.db;

    if (!uid || !db) {
      console.log("‚õî Firestore: uid/db pas pr√™t, message non envoy√©");
      return;
    }

    const ref = window.BUBBLE_AUTH.collection(db, "rooms", "general", "messages");
    const docRef = await window.BUBBLE_AUTH.addDoc(ref, msg);

    console.log("‚úÖ Firestore: message √©crit", docRef.id);
  } catch (e) {
    console.error("‚ùå Firestore: erreur d'√©criture", e);
  }
})();

      
      // Close emoji panel if open
      if (isEmojiPanelOpen) {
        toggleEmojiPanel();
      }
    }
    
    function saveMessages() {
      // Keep only last 100 messages
      if (messages.length > 100) {
        messages = messages.slice(-100);
      }
      localStorage.setItem('bubbleChat_messages', JSON.stringify(messages));
    }
    
    function renderMessages() {
      messagesContainer.innerHTML = '';
      
      // Filtrer les messages des utilisateurs bloqu√©s (sauf pour l'admin)
      const visibleMessages = isAdmin ? messages : messages.filter(msg => 
        msg.type === 'system' || !blockedUsers.includes(msg.user)
      );
      
      let lastDate = null;
      
      visibleMessages.forEach((msg, index) => {
        // V√©rifier si on doit afficher un s√©parateur de date
        const msgDate = new Date(msg.timestamp);
        const msgDateStr = msgDate.toLocaleDateString('fr-FR', { day: 'numeric', month: 'long', year: 'numeric' });
        
        if (lastDate !== msgDateStr) {
          const dateSeparator = document.createElement('div');
          dateSeparator.className = 'flex items-center gap-3 my-4 px-4';
          dateSeparator.innerHTML = `
            <div class="flex-1 h-px" style="background: ${isDarkMode ? 'linear-gradient(to right, transparent, #4d4d4d, transparent)' : 'linear-gradient(to right, transparent, #d1d5db, transparent)'}"></div>
            <span class="text-sm font-semibold px-3 py-1 rounded-full" style="background-color: ${isDarkMode ? '#2d2d2d' : '#e9ecef'}; color: ${isDarkMode ? '#b0b0b0' : '#666666'};">
              ${msgDateStr}
            </span>
            <div class="flex-1 h-px" style="background: ${isDarkMode ? 'linear-gradient(to right, transparent, #4d4d4d, transparent)' : 'linear-gradient(to right, transparent, #d1d5db, transparent)'}"></div>
          `;
          messagesContainer.appendChild(dateSeparator);
          lastDate = msgDateStr;
        }
        
        const msgEl = document.createElement('div');
        msgEl.className = 'animate-fade-in';
        msgEl.style.animationDelay = `${index * 0.02}s`;
        
        if (msg.type === 'system') {
          msgEl.innerHTML = `
            <div class="text-center">
              <span class="inline-block px-4 py-2 rounded-full text-sm" style="background-color: rgba(102, 126, 234, 0.1); color: #667eea;">
                ${escapeHtml(msg.text)}
              </span>
            </div>
          `;
        } else if (msg.type === 'sent') {
          const deleteBtn = isAdmin ? `
            <button onclick="deleteMessage(${msg.id})" class="ml-2 px-2 py-1 rounded text-xs text-white hover:bg-red-600 transition-colors" style="background-color: #ff6b6b;" title="Supprimer">
              üóëÔ∏è
            </button>
          ` : '';
          
          msgEl.innerHTML = `
            <div class="w-full flex justify-end pr-1">
              <div class="flex flex-col items-end" style="max-width: 85%;">
                <p class="text-xs mb-1 mr-1 font-semibold" style="color: ${isDarkMode ? '#b0b0b0' : '#888888'};">
                  ${escapeHtml(msg.user)}
                 ${isAdmin ? `<span class="ml-2 opacity-70">(${escapeHtml((msg.uid || '').slice(0, 8))})</span>` : ``}
                </p>
                <div class="flex items-center justify-end gap-1">
                  ${deleteBtn}
                  <div class="message-bubble sent px-4 py-2 text-white shadow-md" style="background: ${msg.user === '[ADMIN]' ? 'linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%)' : 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)'};">
                    <p style="word-break: break-word;">${escapeHtml(msg.text)}</p>
                    <p class="text-xs opacity-70 mt-1 text-right">${formatTime(msg.timestamp)}</p>
                  </div>
                </div>
              </div>
            </div>
          `;
        } else if (msg.type === 'received') {
          const deleteBtn = isAdmin ? `
            <button onclick="deleteMessage(${msg.id})" class="ml-2 px-2 py-1 rounded text-xs hover:bg-red-100 transition-colors" style="color: #ff6b6b;" title="Supprimer">
              üóëÔ∏è
            </button>
          ` : '';
          
          msgEl.innerHTML = `
            <div class="flex justify-start pl-1">
              <div class="flex items-end gap-2" style="max-width: 85%;">
                <div class="w-8 h-8 rounded-full flex items-center justify-center flex-shrink-0 text-xs font-semibold" style="background-color: ${isDarkMode ? '#4d4d4d' : '#e9ecef'}; color: #666666;">
                  ${escapeHtml(msg.user.charAt(0).toUpperCase())}
                </div>
                <div class="flex flex-col">
                  <p class="text-xs mb-1 ml-1 font-semibold" style="color: ${isDarkMode ? '#b0b0b0' : '#888888'};">
                    ${escapeHtml(msg.user)}
                    ${isAdmin ? `<span class="ml-2 opacity-70">(${escapeHtml((msg.uid || '').slice(0, 8))})</span>` : ``}
                  </p>
                  <div class="flex items-center gap-1">
                    <div class="message-bubble received px-4 py-2 shadow-md" style="background-color: ${isDarkMode ? '#2d2d2d' : '#ffffff'}; color: ${isDarkMode ? '#ffffff' : '#333333'};">
                      <p>${escapeHtml(msg.text)}</p>
                      <p class="text-xs mt-1" style="color: ${isDarkMode ? '#b0b0b0' : '#888888'};">${formatTime(msg.timestamp)}</p>
                    </div>
                    ${deleteBtn}
                  </div>
                </div>
              </div>
            </div>
          `;
        }
        
        messagesContainer.appendChild(msgEl);
      });
      
      // Scroll to bottom
      messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }
    
    function formatTime(timestamp) {
      const date = new Date(timestamp);
      return date.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });
    }
    
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
    
    async function deleteMessage(messageId) {
  if (!isAdmin) return;

  // retrouver le message dans la liste
  const msg = messages.find(m => m.id === messageId);
  if (!msg || !msg._docId) {
    console.log("‚õî Impossible de supprimer : docId manquant");
    return;
  }

  const db = window.BUBBLE_AUTH?.db;
  if (!db) return;

  try {
    // üî• suppression Firestore (pour tout le monde)
    const ref = window.BUBBLE_AUTH.doc(
      db,
      "rooms",
      "general",
      "messages",
      msg._docId
    );

    await window.BUBBLE_AUTH.deleteDoc(ref);
    addSystemMessage("üóëÔ∏è Message supprim√© par l‚Äôadmin.");
  } catch (e) {
    console.error("‚ùå Erreur suppression Firestore", e);
  }
}

// rendre accessible au bouton üóëÔ∏è
window.deleteMessage = deleteMessage;


async function clearAllMessages() {
  if (!isAdmin) return;

  if (!confirm("‚ö†Ô∏è Supprimer TOUS les messages du salon ?")) return;

  const db = window.BUBBLE_AUTH?.db;
  if (!db) return;

  try {
    const colRef = window.BUBBLE_AUTH.collection(db, "rooms", "general", "messages");

    let deleted = 0;

    while (true) {
      // On prend 200 messages √† la fois (safe)
      const q = window.BUBBLE_AUTH.query(colRef, window.BUBBLE_AUTH.limit(200));
      const snap = await window.BUBBLE_AUTH.getDocs(q);

      if (snap.empty) break;

      const batch = window.BUBBLE_AUTH.writeBatch(db);
      snap.forEach((d) => batch.delete(d.ref));
      await batch.commit();

      deleted += snap.size;
      console.log("üßπ Supprim√©s:", deleted);

      // petite pause pour √©viter de ‚Äúforcer‚Äù trop vite
      await new Promise(r => setTimeout(r, 150));
    }

    addSystemMessage(`üßπ Salon vid√© par l'admin (${deleted} messages).`);
  } catch (e) {
    console.error("‚ùå clearAllMessages erreur", e);
    alert("Erreur : suppression impossible (r√®gles Firestore ?)");
  }
}
window.clearAllMessages = clearAllMessages;

    
    // Rendre la fonction accessible globalement
    window.deleteMessage = deleteMessage;
    
    function toggleTheme() {
      isDarkMode = !isDarkMode;
      localStorage.setItem('bubbleChat_darkMode', isDarkMode);
      applyTheme();
    }
    
    function applyTheme() {
      if (isDarkMode) {
        // Mode sombre
        themeIconLight.classList.add('hidden');
        themeIconDark.classList.remove('hidden');
        messagesContainer.style.backgroundColor = '#1a1a1a';
        chatHeader.style.backgroundColor = '#2d2d2d';
        inputArea.style.backgroundColor = '#2d2d2d';
        emojiPanel.style.backgroundColor = '#2d2d2d';
        messageInput.style.backgroundColor = '#3d3d3d';
        messageInput.style.borderColor = '#4d4d4d';
        messageInput.style.color = '#ffffff';
        chatTitle.style.color = '#ffffff';
        chatStatus.style.color = '#b0b0b0';
        themeBtn.classList.remove('hover:bg-gray-100');
        themeBtn.classList.add('hover:bg-gray-700');
        logoutBtn.classList.remove('hover:bg-gray-100');
        logoutBtn.classList.add('hover:bg-gray-700');
      } else {
        // Mode clair
        themeIconLight.classList.remove('hidden');
        themeIconDark.classList.add('hidden');
        messagesContainer.style.backgroundColor = '#f0f2f5';
        chatHeader.style.backgroundColor = '#ffffff';
        inputArea.style.backgroundColor = '#ffffff';
        emojiPanel.style.backgroundColor = '#ffffff';
        messageInput.style.backgroundColor = '#f8f9fa';
        messageInput.style.borderColor = '#e9ecef';
        messageInput.style.color = '#333333';
        chatTitle.style.color = '#333333';
        chatStatus.style.color = '#888888';
        themeBtn.classList.add('hover:bg-gray-100');
        themeBtn.classList.remove('hover:bg-gray-700');
        logoutBtn.classList.add('hover:bg-gray-100');
        logoutBtn.classList.remove('hover:bg-gray-700');
      }
      renderMessages();
    }
    
    function applyConfig(cfg) {
      document.getElementById('app-title').textContent = cfg.app_title || defaultConfig.app_title;
      document.getElementById('chat-title').textContent = cfg.app_title || defaultConfig.app_title;
      document.getElementById('welcome-text').textContent = cfg.welcome_message || defaultConfig.welcome_message;
      codeInput.placeholder = cfg.code_placeholder || defaultConfig.code_placeholder;
      pseudoInput.placeholder = cfg.pseudo_placeholder || defaultConfig.pseudo_placeholder;
    }
    
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê     ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // EVENT LISTENERS
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê    ‚ïê‚ïê      ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    
    validateCodeBtn.addEventListener('click', validateCode);
    codeInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') validateCode();
    });
    
    continueBtn.addEventListener('click', validatePseudo);
    pseudoInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') validatePseudo();
    });
    
    sendBtn.addEventListener('click', sendMessage);
    messageInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') sendMessage();
    });
    
    emojiBtn.addEventListener('click', toggleEmojiPanel);
    themeBtn.addEventListener('click', toggleTheme);
    logoutBtn.addEventListener('click', logout);
    manageUsersBtn.addEventListener('click', toggleUsersPanel);
    closeUsersPanel.addEventListener('click', toggleUsersPanel);
    
    // Close emoji panel when clicking outside
    document.addEventListener('click', (e) => {
      if (isEmojiPanelOpen && !emojiPanel.contains(e.target) && !emojiBtn.contains(e.target)) {
        toggleEmojiPanel();
      }
      if (isUsersPanelOpen && !usersPanel.contains(e.target) && !manageUsersBtn.contains(e.target)) {
        toggleUsersPanel();
      }
    });
    
    // ‚ïê‚ïê‚ïê  ‚ïê   ‚ïê‚ïê‚ïê‚ïê‚ïê    ‚ïê   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê   
    // SDK INITIALIZATION
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê     ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    
    if (window.elementSdk) {
      window.elementSdk.init({
        defaultConfig,
        onConfigChange: async (cfg) => {
          config = { ...defaultConfig, ...cfg };
          applyConfig(config);
        },
        mapToCapabilities: (cfg) => ({
          recolorables: [],
          borderables: [],
          fontEditable: undefined,
          fontSizeable: undefined
        }),
        mapToEditPanelValues: (cfg) => new Map([
          ["app_title", cfg.app_title || defaultConfig.app_title],
          ["welcome_message", cfg.welcome_message || defaultConfig.welcome_message],
          ["code_placeholder", cfg.code_placeholder || defaultConfig.code_placeholder],
          ["pseudo_placeholder", cfg.pseudo_placeholder || defaultConfig.pseudo_placeholder]
        ])
      });
    }
    
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // INITIALIZATION
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê  ‚ïê  ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    
    initEmojiPanel();
    applyConfig(config);
    applyTheme();
    
    // Check if user is already logged in
    const isAuthed = localStorage.getItem('bubbleChat_authed') === 'true';

if (isAuthed && currentUser) {
  isAdmin = localStorage.getItem('bubbleChat_isAdmin') === 'true';
  showChatScreen();
} else {
  showLoginScreen();
}


// ‚úÖ Brancher l'UI sur Firestore (salon unique)
window.addEventListener("bubble-firestore-messages", (e) => {
  const list = Array.isArray(e.detail) ? e.detail : [];

  // üö´ Si je suis exclu, je n'affiche pas et je ne garde pas les messages
  const myUid = window.BUBBLE_AUTH?.uid;
  if (myUid && blockedUids.includes(myUid) && !isAdmin) {
    messages = [];
    renderMessages();
    checkBlockedState();
    return;
  }

  // On remplace l'√©tat local par ce que Firestore a
  messages = list.map((m) => ({
    ...m,
    // Si c'est moi ‚Üí bulle "sent", sinon "received"
    type: (m.uid && window.BUBBLE_AUTH?.uid && m.uid === window.BUBBLE_AUTH.uid) ? "sent" : "received"
  }));

  // Option : garder la limite 100
  if (messages.length > 100) messages = messages.slice(-100);

  renderMessages();
  checkBlockedState();
});


// üö´ R√©ception des exclusions Firestore ‚Üí met √† jour la liste + l'√©cran exclu
window.addEventListener("bubble-firestore-blocked", (e) => {
  blockedUids = Array.isArray(e.detail) ? e.detail : [];
  localStorage.setItem("bubbleChat_blockedUids", JSON.stringify(blockedUids));

  if (isUsersPanelOpen) renderUsersList(); // met √† jour les boutons Exclure/R√©activer
  checkBlockedState(); // affiche/masque l'√©cran "Vous √™tes exclu"
});

// üü¢ Affichage des personnes "en ligne"
window.addEventListener("bubble-firestore-presence", (e) => {
  const arr = Array.isArray(e.detail) ? e.detail : [];
  const now = Date.now();

  // Garde ceux vus il y a moins de 45s
  const online = arr.filter(p => {
    const ts = p.lastSeen?.toDate ? p.lastSeen.toDate().getTime() : 0;
    return ts && (now - ts) < 45000;
  });

  if (!onlineUsersEl) return;

  onlineUsersEl.innerHTML = online.map(p => {
    const name = (p.pseudo || "Sans pseudo").slice(0, 16);
    const initial = name.charAt(0).toUpperCase() || "?";
    return `
      <div class="flex items-center gap-2 px-2 py-1 rounded-full"
           style="background: rgba(102,126,234,0.12);">
        <div class="w-6 h-6 rounded-full flex items-center justify-center text-xs font-bold"
             style="background: rgba(102,126,234,0.25);">
          ${escapeHtml(initial)}
        </div>
        <div class="text-xs whitespace-nowrap">${escapeHtml(name)}</div>
      </div>
    `;
  }).join("");

  if (online.length === 0) {
    onlineUsersEl.innerHTML = `<span class="text-xs opacity-60">personne</span>`;
  }
});

  </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9bf71e49504b26d8',t:'MTc2ODY2NjE4MC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>